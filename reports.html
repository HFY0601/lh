
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>报表页 - 资产领航 V6 Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 text-sm" class="bg-gray-50 text-sm text-gray-800">
<nav class="flex justify-between px-4 py-3 bg-white shadow text-sm font-medium text-gray-600 max-w-3xl mx-auto">
  <a href="index.html" class="hover:text-blue-600">首页</a>
  <a href="assets.html" class="hover:text-blue-600">资产</a>
  <a href="debts.html" class="hover:text-blue-600">负债</a>
  <a href="reports.html" class="text-blue-600 font-bold">报表</a>
  <a href="profile.html" class="hover:text-blue-600">我的</a>
</nav>
<header class="hidden">
  <h1 class="text-lg font-bold text-green-600">📈 收支趋势报表</h1>
</header>
<main class="max-w-3xl mx-auto px-4 py-6 p-4 max-w-3xl mx-auto space-y-6">

  <section class="bg-white shadow rounded-2xl p-6 space-y-3">
    <h2 class="text-base font-semibold text-gray-700">添加记录</h2>
    <form id="recordForm" class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <select id="recordType" class="border rounded-xl p-2">
        <option value="收入">收入</option>
        <option value="支出">支出</option>
      </select>
      <input id="recordCategory" placeholder="分类（如 工资 / 餐饮）" class="border rounded-xl p-2" required />
      <input id="recordAmount" type="number" placeholder="金额" class="border rounded-xl p-2" required />
      <input id="recordDate" type="date" class="border rounded-xl p-2" required />
      <button type="submit" class="col-span-2 bg-green-600 text-white py-2 rounded-xl">➕ 添加记录</button>
    </form>
  </section>

  <section class="bg-white shadow rounded-2xl p-6 space-y-4">
    <div class="flex flex-wrap gap-3 justify-between items-center">
      <h2 class="text-base font-semibold text-gray-700">📊 收支趋势图</h2>
      <div class="flex items-center gap-2">
        <label class="text-xs text-gray-500">分类：</label>
        <select id="filterCategory" class="border rounded p-1 text-sm">
          <option value="全部">全部</option>
        </select>
        <label class="text-xs text-gray-500">维度：</label>
        <select id="filterMode" class="border rounded p-1 text-sm">
          <option value="month">月</option>
          <option value="quarter">季</option>
          <option value="year">年</option>
        </select>
      </div>
    </div>
    <canvas id="trendChart" height="300"></canvas>
  </section>

</main>

<script>
document.getElementById("recordForm").onsubmit = e => {
  e.preventDefault();
  const type = document.getElementById("recordType").value;
  const category = document.getElementById("recordCategory").value;
  const amount = parseFloat(document.getElementById("recordAmount").value);
  const date = document.getElementById("recordDate").value;
  if (!category || isNaN(amount) || !date) return alert("请输入完整记录");

  const tx = JSON.parse(localStorage.getItem("transactions") || "[]");
  tx.push({ type, category, amount, date });
  localStorage.setItem("transactions", JSON.stringify(tx));
  e.target.reset();
  loadTrends();
};

function getPeriod(dateStr, mode) {
  const d = new Date(dateStr);
  if (mode === "year") return d.getFullYear().toString();
  if (mode === "quarter") return d.getFullYear() + "Q" + (Math.floor(d.getMonth() / 3) + 1);
  return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, '0');
}

function loadTrends() {
  const tx = JSON.parse(localStorage.getItem("transactions") || "[]");
  const filterCat = document.getElementById("filterCategory").value;
  const mode = document.getElementById("filterMode").value;

  const incomeMap = {}, expenseMap = {}, labelsSet = new Set(), cats = new Set();

  tx.forEach(t => {
    cats.add(t.category);
    if (filterCat !== "全部" && t.category !== filterCat) return;
    const key = getPeriod(t.date, mode);
    labelsSet.add(key);
    if (t.type === "收入") incomeMap[key] = (incomeMap[key] || 0) + t.amount;
    if (t.type === "支出") expenseMap[key] = (expenseMap[key] || 0) + t.amount;
  });

  const labels = Array.from(labelsSet).sort();
  const income = labels.map(k => incomeMap[k] || 0);
  const expense = labels.map(k => expenseMap[k] || 0);
  const net = labels.map((_, i) => income[i] - expense[i]);

  const ctx = document.getElementById("trendChart").getContext("2d");
  if (window.trendChart) window.trendChart.destroy();
  window.trendChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        { type: "bar", label: "收入", data: income, backgroundColor: "#10b981" },
        { type: "bar", label: "支出", data: expense, backgroundColor: "#ef4444" },
        { type: "line", label: "结余", data: net, borderColor: "#3b82f6", tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: "bottom" } },
      scales: { y: { beginAtZero: true } }
    }
  });

  const catSelect = document.getElementById("filterCategory");
  catSelect.innerHTML = '<option value="全部">全部</option>';
  Array.from(cats).sort().forEach(c => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = c;
    catSelect.appendChild(opt);
  });
}

document.getElementById("filterCategory").onchange =
document.getElementById("filterMode").onchange = loadTrends;

loadTrends();
</script>
</body>
</html>
